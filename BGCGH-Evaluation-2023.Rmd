---
title: "BGCGH Evaluation 2023"
author: "Amy Shuff, Christine"
date: "`r Sys.Date()`"
output:
  html_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

Notes for Leila and Kim:
Anything that shows up in italics like *this* should not stay in the final report. These comments are either copy and pasted from old reports, as example language that we need to update based on the new data, or observations I've made about the data but haven't written down using formal language. 

Notes for Christine:
In the code chunks, I've written UPDATE everywhere something needs to be changed.
Also know that we can't follow individual students year over year using the Club ID. This was something you asked them about in a previous meeting and they thought it was possible. I looked at a few of them and it's not. 

\

Our deadline for the final written report is July 31, 2023.

Draft by July 17th to BGCGH.

UPDATE: Add blues formatting to everything.

\

We still need:

- NYOI 2023 Member Surveys - don't have this year

- Check on NYOI age - 9 


# Last meeting notes

- Show that kids attend, grades are improving, sites should be sustained. This grant will not be continuing next year. Demonstrating the positive impact of BGCGH is most important.
    
- It looks like last year they might have pulled the attendance data from the demographic data. The demographic data you sent me was already aggregated by percent, so I don't have the count of individual students.

- One of the folders is labeled 2023 FALL, which hasn't happened yet. When is this data actually from? Fall 2022?

    + Should be Fall 2022.

- Double check NYOI survey age. Can they take it starting at age 8 or 9? (The online source I found from a BGC video from 2018 said it was for ages nine and up.)

    + Dexter needs to double check.

- Grant attendance targets for BGCGH Texas ACE™ programming (students who attend at least 45 days). Is the number of members or the percentage more important? (What exactly are the targets? Are they the same each year?)

    + Grant target stays the same each year. Number of students is most important.

    + 115 required, 139 reached, from the Women's Home.
    
    + BGCGH came up with these numbers based on what they thought was achievable. Past formulas have been lost for how it came about.

    + Is this required in this report? Because I currently don't have attendance information for this year.

``` {r, results='hide'}

library(knitr)
library(usethis)
library(tidyverse)
library(janitor)
library(reshape2)
library(stringr)
library(here)
library(readxl)
library(pdftools)
#library(kableExtra)

```


# Executive Summary

At the request of Boys and Girls Clubs of Greater Houston (BGCGH), CHILDREN AT RISK conducted an evaluation analysis of the BGCGH Texas Afterschool Centers on Education (Texas ACE™) program in its fifth year in the Spring Branch Independent School District (SBISD). The Texas ACE™ program at BGCGH is designed to provide high-quality academic enrichment opportunities for children and youth during non-school hours. The evaluation report highlights the evaluation findings of the BGCGH Texas ACE™ programming for the 2022-2023 school year.

The findings from this evaluation are pulled from available data sources provided by BGCGH. CHILDREN AT RISK reviewed member and club data from the 2022-2023 school year. The quantitative data includes data on club members as well as aggregated data on each of the five clubs participating in Texas ACE™. Longitudinal data for 2019-2022 was pulled from past evaluation reports.

Required Funding Statement: Funded by the 21st CCLC Program administered by the US Department of Education.

Major Findings on the BGCGH Texas ACE™ program include:

- *Example: There has been an increase in overall attendance for BGCGH Texas ACE™ programs*

- *Example: Site attendance has been better distributed across all 5 sites for 2021-2022*

- *Example: Overall member satisfaction is high across most Club experience measures including Members’ emotional safety and adult connection*


# Introduction and Background

The Boys & Girls Clubs of Greater Houston (BGCGH) was awarded Texas Afterschool Centers on Education (Texas ACE™) grant funding to provide high-quality academic enrichment opportunities for children and youth during non-school hours. BGCGH partnered with Spring Branch Independent School District (SBISD) to provide after school programming with this funding. During the 2022-2023 academic year, BGCGH Texas ACE™ operated at five clubs in SBISD: Spring Branch Elementary School, Spring Oaks Middle School, Westwood Elementary School, Woodview Elementary School, and The Women's Home, a housing and support program that serves students from Treasure Forest Elementary School.

BGCGH requested an evaluation analysis from CHILDREN AT RISK to describe services provided and students served through its Texas ACE™ program during the 2022-2023 academic year. BGCGH was also interested in understanding the quantity and quality of these services, how of the services may support Members’ academic performance, and how BGCGH can make improvements in this programming.

BGCGH provided CHILDREN AT RISK with four sources of quantitative data to inform our analyses in this report. The first were a sample of academic performance records from SBISD for Spring 2021, 2022, and 2023. The second source of quantitative data was from the Boys & Girls Clubs of America’s National Youth Outcomes Initiative (NYOI). The third data source was from the Youth Program Quality Assessment (YPQA) by the The David P. Weikart Center for Youth Program Quality. The fourth and final source of data was aggregated club member demographics and individual attendance records.


The following evaluation questions will be considered:

- How are the BGCGH school-based programs implementing the Texas ACE for the 2022-2023 school year impacting children through the focused program areas of: Academic Success, Social-Emotional Development and Attendance?

- How does BGCGH support equitable access to quality after school programming?

- How have BGCGH ACE sites compared to each other over the past 3 years?

- What impact has BGCGH ACE had on children over the past 5 years of programming?

*I don't know if you want to include the above evaluation questions, but I thought  it would be good to copy them in here for reference when writing the report.*

# Descriptive Statistics on Club Members

Data described in this section comes from aggregated club member demographics and individual attendance records.

## Attendance


```{r}



```


In the 2022-2023 school year, there were 1,047 Club Members that served in BGCGH Texas ACE™. These Members were spread across 5 BGCGH Clubs from Spring Branch Independent School District (SBISD). Membership data included in this analysis are from the following schools in SBISD: Spring Branch Elementary School, Spring Oaks Middle School, The Women’s Home, Westwood Elementary School, and Woodview Elementary School.

Total Club Membership count was obtained from the Teal TX 21st data system and represents the total members who attended at least one day of BGCGH Texas ACE™ programming during 2022-2023 school year.

*Example text: During the 2022-2023 school year, the majority of Members (##%) attended Spring Oak Middle School. Club Membership was spread across the other schools in the following order: Westwood Elementary (##%), Woodview Elementary (##%), The Women’s Home (##%) and Spring Branch Elementary (##%). Spring Oaks was the only school to see a decrease in Club attendance from 2021-2022 to 2022-2023. The other four schools experienced a slight increase in Membership from the 2021-2022 school year. Figure 1 includes a breakdown by club site for members who attended at least one day of BGCGH Texas ACE™ programming.*

```{r Attendance}

# Last year's report included 2020-2021 and 2021-2022 data. 2020 numbers came from the 2019-2020 report. 2019 numbers came from the 2018-2019 report.

attendance <- tibble("Year" = c(2019, 2020, 2021, 2022, 2023), 
                         "Spring Branch Elementary" = c(330, 172, 221, 224, 150),
                         "Spring Oaks Middle" = c(283, 419, 572, 424, 264),
                         "The Women's Home" = c(322, 144, 177, 228, 166),
                         "Westwood Elementary" = c(346, 250, 298, 366, 281),
                         "Woodview Elementary" = c(319, 231, 212, 301, 186)) %>% 
  mutate(Total = `Spring Branch Elementary` + `Spring Oaks Middle` + `The Women's Home` +
                         `Westwood Elementary` + `Woodview Elementary`)

kable(attendance)


attendance.plot <- attendance %>%   
    pivot_longer(c(`Spring Branch Elementary`, `Spring Oaks Middle`, `The Women's Home`,
                         `Westwood Elementary`, `Woodview Elementary`, Total),
               names_to = "Site",
               values_to = "Total Membership")

# This reorders the legend once I make the graph so that Total is on top and not listed alphabetically.
attendance.plot$Site <- factor(attendance.plot$Site, levels = c("Total", "Spring Branch Elementary", "Spring Oaks Middle", "The Women's Home", "Westwood Elementary", "Woodview Elementary"), ordered = TRUE)

# Graph of attendance by site over time
ggplot(attendance.plot, aes(x = Year, y = attendance.plot$`Total Membership`, color = Site)) +
  geom_line() +
  geom_point(position = "dodge") +
  coord_cartesian(ylim = c(0, 1650)) +
  scale_x_continuous(breaks = seq(2019, 2023, 1)) +
  #scale_colour_manual("", values = c("Spring Branch Elementary"= "red", "Spring Oaks Middle"= "orange", "The Women's Home" = "blue", "Westwood Elementary"= "green", "Woodview Elementary" = "pink", "Total" = "Black")) +
  labs(title = "Attendance by Site, 2019-2023") +
  ylab("Total Membership") +
    scale_fill_hue(l=40) +
  theme(panel.background = element_blank()) +
  geom_text(aes(label = ifelse(attendance.plot$Site == 'Total', attendance.plot$`Total Membership`, "")), vjust = 1.5)

# UPDATE (optional): these graph colors aren't great. 

```

*I think it's interesting to see the big dip in membership for 2020. I'm surprised the 2023 numbers are so low. It looks like every club had the lowest attendance numbers since the report started in 2019.*

### Grant Attendance Targets

Texas ACE™ defines regular participation as attending the program 45 days or more during the annual grant period, which includes fall, spring, and summer academic terms. Only students with 45 days of documented program attendance in accordance with program documentation and attendance policies, will be counted toward Texas ACE™ student service goals. 

*Text from past report: Even though only Fall semester program attendance is counted here, 45 days was judged to still be an appropriate cut point because the majority of members at each club reached that level on Fall semester program attendance alone.*

*Example text: All clubs providing BGCGH Texas ACE™ programming met their grant attendance targets. (Members who attend 45+ days), however attendance varied by club location (Table 1). Spring Oak and Woodview surpassed their goals the most compared to other club sites.*

*Note that some values are missing (NA) because the reporting was not consistent from year to year. (These numbers were all pulled from past evaluation reports.)*

```{r}

attendance.grant.2023 <- tibble("Club" = c("Spring Oaks Middle", "The Women's Home", "Spring Branch Elementary", "Woodview Elementary", "Westwood Elementary"),	
                                "Grant Required to attend 45+ Days" = c(100, 115, 110, 110, 110),	
                                "Students that met Attendance	Grant" = c(264, 115,122,163, 182),
                                "Required # to attend Family Engagement Event" = c(40, 45, 44, 44, 44),
                                "Parents that met Attendance" = c(80, 117, 56, 82, 76))

kable(attendance.grant.2023, caption = "Grant Required Attendance for 2023")

```

*I find it a little unbelievable that every single member at Spring Oaks Middle met the grant attendance targets. That hasn't happened any other year at any other club. It's also very uncharacteristic for Spring Oaks.*

```{r}

# Percent of Members Who Attended 45+ Days of ACE Programming by Site
# Previous years data taken from past reports
# UPDATE with 2023 numbers
attendance.grant <- tibble("Year" = c(2019, 2020, 2021, 2022, 2023), 
                         "Spring Branch Elementary" = c(.55, .70, .71, .83, 122/150),
                         "Spring Oaks Middle" = c(.39, .56, .45, .26, 264/264),
                         "The Women's Home" = c(.83, .97, .97, .51, 115/166),
                         "Westwood Elementary" = c(.89, .79, .55, .37, 182/281),
                         "Woodview Elementary" = c(.71, .68, NA, .54, 163/186),
                         "Total" = c(NA, .70, .65, .46, (122 + 264 + 115 + 182 + 163)/1047)) 


# My failed attempts at formatting the percents as percents
# formattable::percent(subset(attendance.grant, select = c('Spring Branch Elementary', Total)), digits = NA, format = "f")
# 
# formattable::percent(subset(attendance.grant, select = 'Spring Branch Elementary':Total), digits = 0, na.rm = TRUE)

# subset(attendance.grant, select = 'Spring Branch Elementary':Total) <- formattable::percent(subset(attendance.grant, select = 'Spring Branch Elementary':Total), digits = 0, na.rm = TRUE)
 
# Next idea, identify numbers that start with . and format those as percents or format each variable individually

kable(attendance.grant, caption = "Percent of Members that Attended at least 45 Days")
# UPDATE: numbers should display as percents (except for Year)

```


```{r}

attendance.grant.plot <- attendance.grant %>%   
    pivot_longer(c(`Spring Branch Elementary`, `Spring Oaks Middle`, `The Women's Home`,
                         `Westwood Elementary`, `Woodview Elementary`, Total),
               names_to = "Site",
               values_to = "Percent of Members")


#The below code works, but then messes up the graph labels
#attendance.grant.plot$`Percent of Members` <- formattable::percent(attendance.grant.plot$`Percent of Members`, digits = 0)

# This reorders the legend once I make the graph so that Total is on top and not listed alphabetically.
attendance.grant.plot$Site <- factor(attendance.grant.plot$Site, levels = c("Total", "Spring Branch Elementary", "Spring Oaks Middle", "The Women's Home", "Westwood Elementary", "Woodview Elementary"), ordered = TRUE)

# Graph of Percent of Members Who Attended 45+ Days of ACE Programming by Site over time
ggplot(attendance.grant.plot, aes(x = Year, y = attendance.grant.plot$`Percent of Members`, color = Site)) +
  geom_line(aes(size = Site)) +
  geom_point(position = "dodge") +
  coord_cartesian(ylim = c(0, 1)) +
  scale_x_continuous(breaks = seq(2019, 2023, 1)) +
  scale_y_continuous(labels = scales::label_percent(accuracy = 1)) +
  scale_size_manual(values = c(1.25, 0.5, 0.5, 0.5, 0.5, 0.5)) +
  labs(title = "Percent of Members Who Attended 45+ Days of ACE Programming, 2019-2023") +
  ylab("Percent of Members") +
    scale_fill_hue(l=40) +
  theme(panel.background = element_blank()) +
  #geom_text(aes(label = ifelse(attendance.grant.plot$Site == 'Total', scales::percent(attendance.grant.plot$`Percent of Members`, accuracy = 1) , "")), vjust = 2.25) 
  geom_label(aes(label = ifelse(attendance.grant.plot$Site == 'Total', scales::percent(attendance.grant.plot$`Percent of Members`, accuracy = 1), "")))

# UPDATE (optional): The aesthetics of this are off. I tried bolding the total line, but it didn't help.
```
*What happened at The Women's Home last year? That's a dramatic change in regular attendance. I took the number from last year's report. You can find our folder for last year here: https://childrenatrisk.sharepoint.com/sites/GDrive/Shared%20Documents/Forms/AllItems.aspx?id=%2Fsites%2FGDrive%2FShared%20Documents%2FCenter%20for%20Social%20Measurement%20and%20Evaluation%2FSharmily%20Working%2FBoys%20ang%20Girls%20Club%20Info&p=true&ct=1684425770678&or=Teams%2DHL&ga=1*



## Member Demographics

Demographic data provided included information on the gender, race, and age of club members from the Fall 2023 semester. Percents do not add up to 100 because each site had some percent not reported.

*Our contract said that we would compare member data with population data at community level. I haven't done that yet.*

```{r}

# UPDATE: Our contract said that we would compare member data with population data at community level. I haven't done that yet.

# Demographics Data
# Import all xlsx files. These have a tab for each site, so I'll use a loop to read in all the tabs.
xlsx.file.list <- list.files(pattern='*.xlsx', recursive = TRUE)
xlsx.list <- list()
for (file in xlsx.file.list){xlsx.list[[file]] <- sapply(excel_sheets(file), read_xlsx, path = file, simplify = FALSE, USE.NAMES = TRUE)}

# 2023 Club Demographics
# View(xlsx.list[[1]])

# UPDATE if file number is different
club.demographics.2023 <- bind_rows(xlsx.list[[1]], .id = "Site") %>% 
  rename(Demographic = Gender,
         demographic.pct = ...2) %>% 
  na.omit() %>% 
  mutate(Site = gsub("SBE", "Spring Branch Elementary", Site),
         Site = gsub("SO", "Spring Oaks Middle", Site),
         Site = gsub("TWH", "The Women's Home", Site),
         Site = gsub("WV", "Woodview Elementary", Site),
         Site = gsub("WW", "Westwood Elementary", Site))

# Gender: Male, Female
# Race: Asian, Black, Latino, Native, White, 2+
# Age: 5 to 9, 10 to 12, 13 to 18

```

### Gender

Westwood Elementary had the highest not reporting gender, at 11%. Note that the options for this survey were only Male or Female.

```{r}

# Gender: Male, Female

club.gender <- club.demographics.2023 %>% 
  # pivot_wider probably would have been an easier option here
  filter(Demographic == 'Male' | Demographic == 'Female') %>% 
  mutate(Male = ifelse(Demographic == 'Male', demographic.pct, NA),
        Female = ifelse(Demographic == "Female", demographic.pct, NA)) %>% 
  group_by(Site) %>% 
  summarise(Male = sum(Male, na.rm = T),
            Female = sum(Female, na.rm = T)) %>% 
  mutate("Not Set" = 1-Male-Female)

kable(club.gender)
# UPDATE: Numbers should display as percents

club.gender.plot <- club.demographics.2023 %>% 
 filter(Demographic == 'Male' | Demographic == 'Female')  

ggplot(club.gender.plot, aes(x = Site, y = demographic.pct)) +
  geom_col(aes(fill = Demographic)) +
  coord_flip() +
  geom_text(aes(label = scales::percent(demographic.pct)), color = "white", hjust = 1.5, position = "stack") +
  labs(title = "Gender") +
  theme(panel.background = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) +
  ylab("Percent") +
  xlab("") +
    scale_fill_hue(l=40)

```


### Race

Latino made up the highest percent of student race at any site, although lack of response was high at Spring Branch Elementary (76%), Spring Oaks Middle (62%), and The Women's Home (49%).

```{r}

# Race: Asian, Black, Latino, Native, White, 2+

club.race <- club.demographics.2023 %>% 
  filter(Demographic == 'Latino' | 
           Demographic == 'White'| 
           Demographic == 'Black'| 
           Demographic == 'Asian' | 
           Demographic == 'Native'| 
           Demographic == '2+') %>% 
  mutate(
      Latino = ifelse(Demographic == "Latino", demographic.pct, NA),
      White = ifelse(Demographic == "White", demographic.pct, NA),
      Black = ifelse(Demographic == "Black", demographic.pct, NA),
      Asian = ifelse(Demographic == "Asian", demographic.pct, NA),
      Native = ifelse(Demographic == "Native", demographic.pct, NA),
      Multiple = ifelse(Demographic == "2+", demographic.pct, NA)) %>% 
  group_by(Site) %>% 
  summarise(
            Latino = sum(Latino, na.rm = T),    
            White = sum(White, na.rm = T),       
            Black = sum(Black, na.rm = T),
            Asian = sum(Asian, na.rm = T),
            Native = sum(Native, na.rm = T),
            Multiple = sum(Multiple, na.rm = T)) %>% 
  mutate("Not Set" = 1-Asian-Black-Latino-Native-White-Multiple)

kable(club.race)
# UPDATE: Numbers should display as percents

club.race.plot <- 
  club.demographics.2023 %>% 
  filter(Demographic == 'Latino' | 
           Demographic == 'White'| 
           Demographic == 'Black'| 
           Demographic == 'Asian' | 
           Demographic == 'Native'| 
           Demographic == '2+') %>% 
    mutate(Demographic = factor(Demographic, levels=c("2+", "Asian", "Native", "Black", "White", "Latino")))


ggplot(club.race.plot, aes(x = Site, y = demographic.pct)) +
  geom_col(aes(fill = Demographic)) +
  coord_flip() +
  geom_text(aes(label = ifelse(Demographic == "Latino", scales::percent(demographic.pct), '')), 
                color = "white", hjust = 2, position = "stack") +
  labs(title = "Race") +
  theme(panel.background = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) +
  ylab("Percent") +
  xlab("")  +
    scale_fill_hue(l=40)

# UPDATE: The colors of this graph are not great

```


### Age

Ages five to nine were the most represented at all sites except Spring Oaks Middle, which was primarily ages thirteen to eighteen.

```{r}

# Age: 5 to 9, 10 to 12, 13 to 18

club.age <- club.demographics.2023 %>%
  filter(Demographic == '5 to 9' | 
           Demographic == '10 to 12'| 
           Demographic == '13 to 18') %>% 
  mutate(
      "Five_Nine" = ifelse(Demographic == '5 to 9', demographic.pct, NA),
      "Ten_Twelve" = ifelse(Demographic == '10 to 12', demographic.pct, NA),
      "Thirteen_Eighteen" = ifelse(Demographic == '13 to 18', demographic.pct, NA)) %>% 
  group_by(Site) %>% 
  summarise(Five_Nine = sum(Five_Nine, na.rm = T),    
            Ten_Twelve = sum(Ten_Twelve, na.rm = T),       
            Thirteen_Eighteen = sum(Thirteen_Eighteen, na.rm = T)) %>% 
  mutate("Not Set" = 1-Five_Nine-Ten_Twelve-Thirteen_Eighteen)

# might try using pivot_wider() on club.demographics.2023 to see if it works better

kable(club.age)
# UPDATE: rename table headings (Site, "13 to 18", "10 to 12", "5 to 9", "Not Set")
# and display numbers as percents

club.age.plot <- 
  club.demographics.2023  %>% 
  filter(Demographic == '5 to 9' | 
           Demographic == '10 to 12'| 
           Demographic == '13 to 18') %>% 
  mutate(Demographic = factor(Demographic, levels=c("13 to 18", "10 to 12", "5 to 9")))


ggplot(club.age.plot, aes(x = forcats::fct_rev(Site), y = demographic.pct)) +
  geom_col(aes(fill = Demographic)) +
  coord_flip() +
  geom_text(aes(label = ifelse(Demographic == "5 to 9" | Demographic == "13 to 18", scales::percent(demographic.pct), '')), 
                color = "white", hjust = 1.5) +
  labs(title = "Age") +
  theme(panel.background = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) +
  ylab("Percent") +
  xlab("")  +
    scale_fill_hue(l=40)

# UPDATE: The labels here need to be adjusted. I don't know why the Women's Home 13 to 18 label is in such a weird place.

```

## Academic Grades 

Report card data in this section was provided by SBISD to BGCGH. We reviewed and analyzed data on members’ academic grades in the two core courses: Math and English/Reading. 

When reporting numeric values for grades, we used a traditional 0 to 4 grade point scale in which 0 represents a grade of ‘F’ and 4 represents a grade of ‘A.’ Kindergarten students are not included in any analysis of reporting of grades here due to the small number of members in that grade and a different grading scale.

A limitation of this analysis is the amount of available report cards. Although there were 1,047 members, only 889 report cards were available. 

Data from 2022 is limited to 351 report cards and data from Spring 2021 is limited to 797 report cards. This is not a large enough sample size to draw conclusions from.


```{r Import ACE Data}

# ACE Data
# Import all csv files
csv.file.list <- list.files(pattern='*.csv', recursive = TRUE)
csv.list <- sapply(csv.file.list, read.csv, simplify = FALSE, USE.NAMES = TRUE)


# I went in to each ACE file and manually changed column names in Excel so that they were all the same across sites and years. (Site, Grade, Number of School Days, Number of Texas ACE Days, Math, English Reading)


# ACE Spring 2021
# View(csv.list[[5]]) # includes Year (2021) and Term (Spring). UID had preceding C for some sites. I took those out.

# Join all ACE Spring 2021 files together
# UPDATE if file numbers are different
ace2021 <- bind_rows(list(csv.list[[1]], csv.list [[2]], csv.list[[3]], csv.list[[4]], csv.list[[5]]), .id = "id") %>% 
  mutate(Year = as.numeric(2021),
         Term = "Spring",
         Data = "ACE",
         HostSiteName = gsub("The Womens' Home", "The Women's Home", HostSiteName)) %>% 
  rename(Site = HostSiteName,
         Number.of.School.Days = SchoolDaysEnrolled,
         Number.of.Texas.ACE.Days = ACE.Days.Attended,
         Math = MathGrade,
         English.Reading = ReadingGrade) 

# UPDATE (I need help here): figure out how to remove duplicate UIDs
ace2021.duplicates <- ace2021$UID[duplicated(ace2021$UID)]
# paste(ace2021.duplicates)
# "1841070" "1837954" "1838312" "1838401" "1839453" "1840898"

ace2021 <- ace2021 %>% 
  select(Site, Grade, Number.of.School.Days, Number.of.Texas.ACE.Days, Math, English.Reading, Year, Term, Data)
# Quite a few grades are missing from the 2021 data



# ACE 2022 (Probably Spring. It looks like last year's data.)
# Club.ID now starts with site name initials instead of a column for Site
# View(csv.list[[6]]) # Grade is number (1)
# View(csv.list[[7]]) # Grade is number (1)
# View(csv.list[[8]]) # Grade is character (1st), but one is listed as 1nd. Changed to 1st.
# View(csv.list[[9]]) # Grade is character (1st)
# View(csv.list[[10]]) # Grade is character (1st)

# Join all 2022 files together
# UPDATE if file numbers are different
ace2022 <- bind_rows(list(csv.list[[6]], csv.list[[7]]), .id = "id") %>% 
  mutate(Data = "ACE",
         Grade = gsub("1", "1st", Grade),
         Grade = gsub("2", "2nd", Grade),
         Grade = gsub("3", "3rd", Grade),
         Grade = gsub("4", "4th", Grade),
         Grade = gsub("5", "5th", Grade),
         Grade = gsub("6", "6th", Grade),
         Grade = gsub("7", "7th", Grade),
         Grade = gsub("8", "8th", Grade)) %>% 
  bind_rows(., list(csv.list[[8]], csv.list[[9]], csv.list[[10]]), .id = "id") %>% 
  mutate(Year = as.numeric(2022),
         Data = "ACE")
ace2022 <- ace2022 %>% 
  mutate(Site = ifelse(substr(ace2022$Club.ID, 1, 3) == "SOM", "Spring Oaks Middle", ""),
         Site = ifelse(substr(ace2022$Club.ID, 1, 3) == "SBE", "Spring Branch Elementary", Site),
         Site = ifelse(substr(ace2022$Club.ID, 1, 3) == "TWH", "The Women's Home", Site),
         Site = ifelse(substr(ace2022$Club.ID, 1, 3) == "WWE", "Westwood Elementary", Site),
         Site = ifelse(substr(ace2022$Club.ID, 1, 2) == "WV", "Woodview Elementary", Site),
         Term = "Spring")

ace2022.duplicates <- ace2022$Club.ID[duplicated(ace2022$Club.ID)]
# paste(ace2022.duplicates)
# No duplicates in 2022 data

ace2022 <- ace2022 %>% 
  select(Site, Grade, Number.of.School.Days, Number.of.Texas.ACE.Days, Math, English.Reading, Year, Term, Data)

# 2022 ACE data has 174 school days for all students. 2021 ACE data has SchoolDaysEnrolled and SchoolDayClasses, which both range from 0 to 94. But they're not always the same, nor do they match ACE Days Attended.



# ACE 2022 Fall
# These were sent at xlsx, but since the last two years were csv, I resaved them as csv.

# View(csv.list[[11]]) # Grade is character (1st)
# View(csv.list[[12]]) # Grade is number (1)
# View(csv.list[[13]]) # Grade is character (1st)
# View(csv.list[[14]]) # Grade is number (1)
# View(csv.list[[15]]) # Grade is character (1st)

ace2022.fall <- bind_rows(list(csv.list[[12]], csv.list[[14]]), .id = "id") %>% 
  mutate(Grade = gsub("1", "1st", Grade),
         Grade = gsub("2", "2nd", Grade),
         Grade = gsub("3", "3rd", Grade),
         Grade = gsub("4", "4th", Grade),
         Grade = gsub("5", "5th", Grade),
         Grade = gsub("6", "6th", Grade),
         Grade = gsub("7", "7th", Grade),
         Grade = gsub("8", "8th", Grade)) %>% 
  bind_rows(., list(csv.list[[11]], csv.list[[13]], csv.list[[15]]), .id = "id")%>% 
  mutate(Year = as.numeric(2022),
         Data = "ACE")
ace2022.fall <- ace2022.fall %>% 
  mutate(Site = ifelse(substr(ace2022.fall$Club.ID, 1, 3) == "SOM", "Spring Oaks Middle", ""),
         Site = ifelse(substr(ace2022.fall$Club.ID, 1, 3) == "SBE", "Spring Branch Elementary", Site),
         Site = ifelse(substr(ace2022.fall$Club.ID, 1, 3) == "TWH", "The Women's Home", Site),
         Site = ifelse(substr(ace2022.fall$Club.ID, 1, 2) == "WW", "Westwood Elementary", Site),
         Site = ifelse(substr(ace2022.fall$Club.ID, 1, 2) == "WV", "Woodview Elementary", Site),
         Term = "Fall")

ace2022.fall.duplicates <- ace2022.fall$Club.ID[duplicated(ace2022.fall$Club.ID)]
# paste(ace2022.fall.duplicates)
# No club ID duplicates

ace2022.fall.total <- ace2022.fall

ace2022.fall <- ace2022.fall %>% 
  select(Site, Grade, Math, English.Reading, Year, Term, Data)



# ACE 2023 Spring

# These were sent at xlsx, but since the last two years were csv, I resaved them as csv.
# View(csv.list[[16]]) # Grade is character (1st)
# View(csv.list[[17]]) # Grade is number (1)
# View(csv.list[[18]]) # Grade is character (1st). Also has some N/A values listed for grades.
# View(csv.list[[19]]) # Grade is number (1)
# View(csv.list[[20]]) # Grade is character (1st)

ace2023.spring <- bind_rows(list(csv.list[[17]], csv.list[[19]]), .id = "id")  %>% 
  mutate(Grade = gsub("1", "1st", Grade),
         Grade = gsub("2", "2nd", Grade),
         Grade = gsub("3", "3rd", Grade),
         Grade = gsub("4", "4th", Grade),
         Grade = gsub("5", "5th", Grade),
         Grade = gsub("6", "6th", Grade),
         Grade = gsub("7", "7th", Grade),
         Grade = gsub("8", "8th", Grade)) %>% 
  bind_rows(., list(csv.list[[16]], csv.list[[18]], csv.list[[20]]), .id = "id")

ace2023.spring <- ace2023.spring %>% 
  mutate(Site = ifelse(substr(ace2023.spring$Club.ID, 1, 3) == "SOM", "Spring Oaks Middle", ""),
         Site = ifelse(substr(ace2023.spring$Club.ID, 1, 3) == "SBE", "Spring Branch Elementary", Site),
         Site = ifelse(substr(ace2023.spring$Club.ID, 1, 3) == "TWH", "The Women's Home", Site),
         Site = ifelse(substr(ace2023.spring$Club.ID, 1, 2) == "WW", "Westwood Elementary", Site),
         Site = ifelse(substr(ace2023.spring$Club.ID, 1, 2) == "WV", "Woodview Elementary", Site),
         Year = as.numeric(2023),
         Term = "Spring",
         Data = "ACE")

ace2023.comet.duplicates <- ace2023.spring$Comet.ID[duplicated(ace2023.spring$Comet.ID)]
# paste(ace2023.comet.duplicates)
# "1826954" "1841066" "1845474" "1853139" "1842531" "1851898" "1845379" "1854408" "1845372" "1852067" "1845368"

ace2023.duplicates <- ace2023.spring$Club.ID[duplicated(ace2023.spring$Club.ID)]
# paste(ace2023.duplicates)
# No club ID duplicates, though. So maybe we don't remove any?


ace2023.spring.total <- ace2023.spring

ace2023.spring <- ace2023.spring %>% 
  select(Site, Grade, Math, English.Reading, Year, Term, Data)

```



```{r}

ace2022.counts <- ace2022 %>% 
  group_by(Site) %>% 
  summarise(Kindergarten = sum(Grade == 'Kinder'),
            "1st" = sum(Grade == '1st'),
            "2nd" = sum(Grade == '2nd'),
            "3rd" = sum(Grade == '3rd'),
            "4th" = sum(Grade == '4th'),
            "5th" = sum(Grade == '5th'),
            "6th" = sum(Grade == '6th'),
            "7th" = sum(Grade == '7th'),
            "8th" = sum(Grade == '8th'))
  
kable(ace2022.counts, caption = "2022 Report Card Counts")



#UPDATE, optional: It would be nice to recreate this chart with 2023 data.

ace2023.counts <- bind_rows(list(ace2022.fall, ace2023.spring), .id = "id") %>% 
  group_by(Site) %>% 
  summarise(Kindergarten = sum(Grade == 'Kinder', na.rm = TRUE),
            "1st" = sum(Grade == '1st', na.rm = TRUE),
            "2nd" = sum(Grade == '2nd', na.rm = TRUE),
            "3rd" = sum(Grade == '3rd', na.rm = TRUE),
            "4th" = sum(Grade == '4th', na.rm = TRUE),
            "5th" = sum(Grade == '5th', na.rm = TRUE),
            "6th" = sum(Grade == '6th', na.rm = TRUE),
            "7th" = sum(Grade == '7th', na.rm = TRUE),
            "8th" = sum(Grade == '8th', na.rm = TRUE))
# Two students from Spring Oaks Middle, fall 2022, are missing grade level information


kable(ace2023.counts, caption = "2023 Report Card Counts")


```

*I thought I might be able to see see total attendance by looking at number of report cards, but once again there aren't enough here.*

```{r 2023 totals}

attendance.2023 <- bind_rows(list(ace2022.fall.total, ace2023.spring.total)) %>% 
  select(Club.ID, Site, Year, Term, Number.of.School.Days.Fall.Semester) %>% 
  group_by(Club.ID, Site) %>% 
  summarise(Number.of.School.Days.Fall.Semester = sum(Number.of.School.Days.Fall.Semester))

attendance.2023.total <- attendance.2023 %>% 
  ungroup() %>% 
  summarise("Total Report Cards 2023" = length(unique(Club.ID)))

kable(attendance.2023.total)


attendance.2023.clubs <- attendance.2023 %>% 
  ungroup() %>% 
  group_by(Site) %>% 
  summarise("Report Cards by Club 2023" = length(unique(Club.ID)))

kable(attendance.2023.clubs)

```

*I left out fall 2022 here so that we're comparing only the spring semester each year. The following graphs represent only the Spring semester.*

```{r Bind ACE 2021-2023 Data}

# I'm going to leave out ace2022.fall since all the other years only looked at spring semester.

ace <- bind_rows(list(ace2021, ace2022, ace2023.spring)) %>%
  # Kinder has Pass/Fail. They were excluded from previous reports, so we'll do the same.
  filter((!Grade == "Kindergarten" & !Grade == "Kinder") %>% replace_na(TRUE)) %>% 
  # 2022 GPA Methodology – Letter grades were converted to gpa scale where A=4, B=3, C=2, D=1, F=0 then averaged and rounded to the nearest whole number. Methodology consistent with 2020-2021 report.
  mutate(Math = ifelse(Math == "A", 4, Math),
         Math = ifelse(Math == "B", 3, Math),
         Math = ifelse(Math == "C", 2, Math),
         Math = ifelse(Math == "D", 1, Math),
         Math = ifelse(Math == "F", 0, Math),
         Math = as.numeric(Math),
         English.Reading = ifelse(English.Reading == "A", 4, English.Reading),
         English.Reading = ifelse(English.Reading == "B", 3, English.Reading),
         English.Reading = ifelse(English.Reading == "C", 2, English.Reading),
         English.Reading = ifelse(English.Reading == "D", 1, English.Reading),
         English.Reading = ifelse(English.Reading == "F", 0, English.Reading),
         English.Reading = as.numeric(English.Reading)) 

# One kid has an S in math (2022 The Women's Home), but as.numeric makes it NA, so it's automatically dropped
# Quite a few grades missing from 2021 data
# The Women's Home 2023 has some N/A values for grades

```


*I'm not sure how to organize the below table. Maybe by year would be best? Note that we have Fall 2022 data, but I'm only including spring semesters for continuity over longitudinal data.*

```{r Average Math and Reading GPAs}

# Average Math and English/Reading GPAs

ace.averages <- ace %>% 
  group_by(Site, Year, Term) %>% 
  summarise(Math = mean(Math, na.rm = TRUE),
            English.Reading = mean(English.Reading, na.rm = TRUE),
            "Number of Report Cards" = n()) %>% 
  mutate_if(is.numeric, round, digits = 2)

kable(ace.averages, caption = "Average GPA by Site and Year", digits = 2)

# UPDATE: I think this table should be organized by year.

# UPDATE (optional):
# one of the old reports did a histogram with the frequency of grades. I like that idea.
# geom_histogram() or geom_freqpoly()

```


### Math GPA

On average, math grades seem to have improved from 2021 to 2022. But we also have significantly fewer report cards to analyze, so there's a chance this wasn't a significant change.

```{r Math GPA over time}

# Math GPA by Site and Year

ggplot(ace.averages, aes(x = Site, y = Math, fill = factor(ace.averages$Year))) +
  geom_bar(stat = "identity", position = "dodge") +
  coord_flip() +
  geom_text(aes(label = Math), 
                color = "white",
            position = position_dodge(width = .9),
            hjust = 2) +
  labs(title = "Average Math GPA by Site and Year") +
  theme(panel.background = element_blank()) +
  ylab("Average Math GPA") +
  xlab("") +
  guides(fill = guide_legend(title = "Year")) +
    scale_fill_hue(l=40)

    
```


### English/Reading GPA

As with Math, there seems to be an increase in the average English/Reading grades from 2021 to 2022.

```{r}

# English/Reading GPA by Site and Year

ggplot(ace.averages, aes(x = Site, y = English.Reading, fill = factor(ace.averages$Year))) +
  geom_bar(stat = "identity", position = "dodge") +
  coord_flip() +
  geom_text(aes(label = English.Reading), 
                color = "white",
            position = position_dodge(width = .9),
            hjust = 2) +
  labs(title = "Average English/Reading GPA by Site and Year") +
  theme(panel.background = element_blank()) +
  ylab("Average English/Reading GPA") +
  xlab("") +
  guides(fill = guide_legend(title = "Year")) +
    scale_fill_hue(l=40)

    
```

### Overall Grades

*The below table shows just how wide the variation is in the supplied number of report cards each year. This is what makes it impossible to draw conclusions from 2021 and 2022 data*


```{r }

# 2019 report has average GPA by site and subject. We would have to weight the averages by attendance for that year to get total subject average. There isn't a report card for each student, so this wouldn't be exact.

# 2020 report has average grade by site and subject as well. (Math: SB=2.41, SOM=2.32, TWH=2.3, WW=2.34, WV=1.74, Reading: SB = 2.29, SOM=2.13, TWH=2.2, WW=2.4, WV=1.75) There are 1,072 report cards and 1,216 members.

# 2021 has averages by subject and term.. I averaged the two terms and added it to the data below.

# It looks like there's a dramatic increase in grades for 2022, but with so few report cards, it's hard to say if it's a significant increase.

# UPDATE: Add 2023 data here if wanted. 
# I don't know if you all want this in the final report, but I thought the number of report cards each year was important. Maybe move it to the begining of the Grades section?
ace.overall <- ace %>% 
  group_by(Year) %>% 
  summarise(Math = mean(Math, na.rm = TRUE),
            English.Reading = mean(English.Reading, na.rm = TRUE),
            "Number of Report Cards" = n()) %>% 
  rbind(., c(2020, 2.25, 2.1, 1432)) %>% 
  rbind(., c(2019, (2.41*172+2.32*419+2.3*144+2.34*250+1.74*231)/1216, (2.29*172+2.13*419+2.2*144+2.4*250+1.75*231)/1216, 1072)) %>% 
  mutate_if(is.numeric, round, digits = 2) %>% 
  arrange(Year)

kable(ace.overall, caption = "Average GPA by Year", digits = 2)

```


*This didn't turn out to be as interesting as I thought it might be. I'd probably leave this out of the final report or stick it into an appendix. With so few report cards, the increase in 2022 might be statistically insignificant.*

```{r Grades over time}

ace.overall.plot <- ace.overall %>% 
  pivot_longer(c(Math, English.Reading), 
               names_to = "Subject", 
               values_to = "GPA")

ggplot(ace.overall.plot, aes(x = Year)) +
  geom_line(aes(y = GPA, color = Subject)) +
  coord_cartesian(ylim = c(0, 4)) +
  labs(title = "GPA Averages by Year",
       subtitle = "for all BGCGH sites combined") +
  scale_x_continuous(breaks=seq(2019, 2023, 1))

```


# Club-Level Data 

## National Youth Outcomes Initiative (NYOI)

*This is from the report walkthrough document they sent us: We participate in an annual survey to hear directly from youth about their Club experience. This survey collects information on selected modules that vary Club. Some of the modules include: Club Experience, Safety, Healthy Lifestyles, Academic Success, Good Character, SEL, Art, STEM, Bullying, Workforce, Risky Behavior. , (This sentence was unfinished.)*

This survey is intended for members that are ages nine and up to give youth perspective on the club.

For more information about NYOI and how it measures Boys and Girls Club experiences: https://clubexperience.blog/2018/02/22/how-do-we-measure-the-club-experience/

*Taken on computer. Can take 20-25 minutes. Can be taken over multiple days.*
*8 years and older, must have parent consent, members opt in with incentive program. Expect 2023 data mid to late June. The surveys were completed in February. Previously they were done in Oct/Nov.*

```{r NYOI Data Import, echo=FALSE}

# NYOI Member Survey Reports are xlsx files 2 and 3
# Import all xlsx files. These have a tab for each site, so I'll use a loop to read in all the tabs.
xlsx.file.list <- list.files(pattern='*.xlsx', recursive = TRUE)
xlsx.list <- list()
for (file in xlsx.file.list){xlsx.list[[file]] <- sapply(excel_sheets(file), read_xlsx, path = file, simplify = FALSE, USE.NAMES = TRUE)}



# Each member survey report needs to have the same column names for bind_rows to work, so here I'll rename them

site.names <- c("Spring Oaks Middle", "The Women's Home", "Westwood", "Spring Branch Elem", "Woodview")

nyoi.2021.list <- list()
for (site in site.names){
  nyoi.raw <- data.frame(xlsx.list[[2]][site]) # UPDATE number here if file number is different
  colnames(nyoi.raw) <- c("Measure", "Optimal", "Fair", "Needs Improvement")
  nyoi.2021.list[[site]] <- nyoi.raw
}
nyoi.2021 <- bind_rows(nyoi.2021.list, .id = "Site") %>% 
  replace(is.na(.), "") %>% 
  mutate(Year = 2021, .before = Site)


nyoi.2022.list <- list()
for (site in site.names){
  nyoi.raw <- data.frame(xlsx.list[[3]][site]) # UPDATE number here if file number is different
  colnames(nyoi.raw) <- c("Measure", "Optimal", "Fair", "Needs Improvement")
  nyoi.2022.list[[site]] <- nyoi.raw
}
nyoi.2022 <- bind_rows(nyoi.2022.list, .id = "Site") %>% 
  replace(is.na(.), "") %>% 
  mutate(Year = 2022, .before = Site)

# UPDATE: the below code should work for the NYOI 2023 file
# nyoi.2023.list <- list()
# for (site in site.names){
#   nyoi.raw <- data.frame(xlsx.list[[4]][site]) # UPDATE number here if file number is different
#   colnames(nyoi.raw) <- c("Measure", "Optimal", "Fair", "Needs Improvement")
#   nyoi.2023.list[[site]] <- nyoi.raw
# }
# nyoi.2023 <- bind_rows(nyoi.2023.list, .id = "Site") %>% 
#   replace(is.na(.), "") %>% 
#   mutate(Year = 2023, .before = Site)


nyoi <- bind_rows(nyoi.2021, nyoi.2022) # UPDATE: add nyoi 2023

```

*Why do we have so few survey responses? I don't think we can reasonably draw conclusions from such a small sample size.*

*Past report text: There were ### valid survey responses collected across the five clubs. CHILDREN AT RISK is not aware of the reason for the discrepancy in the number of Club Members and the number of valid surveys.*

```{r NYOI Responses}

nyoi.responses <- nyoi %>% 
  filter(Measure == "# of Member Responses") %>% 
  mutate("# of Member Responses" = as.numeric(Optimal)) %>%
  select(Year, Site, "# of Member Responses") %>% 
  group_by(Year) %>% 
  summarise("# of Member Responses" = sum(`# of Member Responses`))

kable(nyoi.responses)

# I think the below code looks better, but it won't knit to a word document
# kbl(nyoi.responses, caption = "NYOI Survey Response Counts") %>%
#   kable_paper(bootstrap_options = "striped", full_width = F)

```

### Club Experience Measures

The NYOI is a survey of the experiences and perceptions of the club completed by club members. Individual responses to survey items are compiled into a variety of measures, seven of which make up the The Club Experience Indicator and are detailed in this report: Emotional Safety, Physical Safety, Fun, Sense of Belonging, Adult Connections, Staff Expectations, and Recognition. Each of the seven measures is reported in aggregate for each BGCGH club.

*2021 Report text: When we compared the NYOI results for the 2020 fall term to the 2019 fall term (see Figure 12), we noted substantial improvements. All measures had a positive change in the percent of members reporting an Optimal experience, most dramatically in Emotional Safety and Sense of Belonging. Fun and Recognition saw the smallest increase. The percentage of members reporting Needs Improvement increased for Adult Expectations and Fun at Spring Branch Elementary and for Fun at Westwood Elementary. Perhaps the most remarkable finding is that the percentage of students reporting feeling Optimal Physical Safety at the clubs increased during a pandemic.*

```{r NYOI Visualizations, fig.dim = c(10, 12)}

# Past years only looked at Emotional Safety, Physical Safety, Fun, Sense of Belonging, Adult Connections, Expectations, and Recognition.

nyoi.plot <- nyoi %>% 
  filter(Measure == "Overall Club Experience" |
         Measure == "Emotional Safety" | 
         Measure == "Physical Safety" | 
         Measure == "Fun" | 
         Measure == "Sense of Belonging" | 
         Measure == "Adult Connections" | 
         Measure == "Expectations" | 
         Measure == "Recognition") %>% 
  select(Year, Site, Measure, Optimal, Fair, "Needs Improvement") %>% 
  pivot_longer(c(Optimal, Fair, "Needs Improvement"),
               names_to = "Score",
               values_to = "Value") %>%
  mutate(Value = gsub("%", "", Value),
         Value = as.numeric(Value),
         Value = ifelse(Value>=1, Value/100, Value),
         Score = factor(Score, levels= c('Needs Improvement', 'Fair', 'Optimal')))



nyoi.experience <- nyoi.plot %>% 
  filter(Measure == "Emotional Safety" | 
         Measure =="Physical Safety" | 
         Measure =="Fun" | 
         Measure =="Sense of Belonging" | 
         Measure =="Adult Connections" | 
         Measure =="Expectations" | 
         Measure =="Recognition")

ggplot(data = nyoi.experience, aes(x = Measure, y = Value, fill = Score)) + 
  geom_col(position = "stack") + 
  facet_grid(rows = vars(Site), cols = vars(Year)) +
  labs(y = "Percent Response",
       title = "Club Experience Measures") +
  guides(x = guide_axis(angle = 90)) +
  scale_y_continuous(labels = scales::label_percent(accuracy = 1)) +
  scale_fill_brewer(name = "", labels = c("Needs Improvement", "Fair", "Optimal"), palette = "Blues") +
  geom_text(aes(label = ifelse(Score == "Optimal", scales::percent(Value, accuracy = 1), '')), color = "black", vjust = 1.5, position = "stack") +
    theme(panel.background = element_blank())

# UPDATE: I'd like to reorder the measures to show highest rated measures on the left and lowest on the right, so it's easy to see at a glance what's in most need of improvement.

```
*The recognition scores at Woodview were low in 2021 and got even worse for 2022. Those numbers are concerning. In 2022 Recognition had the highest Needs Improvement scores for every site except Spring Branch Elementary.*

An Optimal score requires the member to:

- answer all questions in the category

- Not disagree with any item

- Strongly agreed with at least two 


An item would be categorized as Needs Improvement if a member disagreed or strongly disagreed with at least two of the questions.

```{r NYOI Recognition, fig.height=10, fig.width=6}

# To look closer at the recognition score, these are the items that make up that measure: "Adults at this Club notice when I try my best" | "Adults here encourage me when I make positive choices" | "Adults at this Club ask my opinion on things" | "My ideas count here" | "I get to help make this Club better"

nyoi.recognition <- nyoi %>% 
  filter(Measure == "Adults at this Club notice when I try my best" | 
         Measure == "Adults here encourage me when I make positive choices" | 
         Measure == "Adults at this Club ask my opinion on things" | 
         Measure == "My ideas count here"  | 
         Measure == "I get to help make this Club better") %>% 
  rename(Item = Measure,
         "Very true" = Optimal,
         "Sort of true" = Fair,
         "Not very true" = "Needs Improvement",
         "Not true at all" = ...7) %>% 
  select(Year, Site, Item, "Very true", "Sort of true", "Not very true", "Not true at all") %>% 
  pivot_longer(c("Very true", "Sort of true", "Not very true", "Not true at all"),
               names_to = "Score",
               values_to = "Value") %>%
  mutate(Value = gsub("%", "", Value),
         Value = as.numeric(Value),
         Value = ifelse(Value>=1, Value/100, Value),
         Score = factor(Score, levels= c("Not true at all", "Not very true", "Sort of true", "Very true"))) %>% 
  pivot_wider(names_from = Score, values_from = Value)

  # I'm changing the categorizes to a simple "True" or "Not true" to better capture the "Needs Improvement" rating  
nyoi.recognition <- nyoi.recognition %>% 
    mutate(True = `Very true` + `Sort of true`,
         "Not true" = `Not very true` + `Not true at all`) %>% 
  select(Year, Site, Item, "True", "Not true") %>% 
  pivot_longer(c("True", "Not true"),
               names_to = "Score",
               values_to = "Value")



ggplot(data = nyoi.recognition, aes(x = Item, y = Value, fill = Score)) + 
  geom_col(position = "stack") + 
  facet_grid(rows = vars(Site), cols = vars(Year)) +
  labs(y = "Percent Response",
       title = "Recognition Items") +
  guides(x = guide_axis(angle = 90)) +
  scale_y_continuous(labels = scales::label_percent(accuracy = 1)) +
  scale_fill_brewer(name = "", palette = "Blues") +
  geom_text(aes(label = ifelse(Score == "Not true", scales::percent(Value, accuracy = 1), '')), color = "black", vjust = 1.5, position = "stack") +
    theme(panel.background = element_blank())


```

In 2022, 36% of of surveyed members from Woodview answered either "Not true at all" or "Not very true" to the statement "My ideas count here."


### Overall Club Experience

Members overall club experience is also categorized. This is done using all seven measures: Fun, Sense of Belonging, Physical Safety, Emotional Safety, Adult Connections, Recognition, Staff Expectations.

Members overall club experience is considered optimal if it meets two conditions:

- Their club experience must be optimal in at least three of the seven measures.

- Their club experience does not fall into the needs improvement category for any of the measures.


```{r NYOI Overall Club Experience, fig.height=8, fig.width=6}

# I was thinking this would be the easiest way to see trends in longitudinal data
# UPDATE, if wanted: maybe change it to a line graph of optimal over time?

nyoi.overall <- nyoi.plot %>% 
  filter(Measure == "Overall Club Experience")  

ggplot(data = nyoi.overall, aes(x = Measure, y = Value, fill = Score)) + 
  geom_col(position = "stack") + 
  facet_grid(rows = vars(Site), cols = vars(Year)) +
  labs(y = "Percent Response",
       title = "Overall Club Experience") +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_brewer(name = "", labels = c("Needs Improvement", "Fair", "Optimal"), palette = "Blues") +
  geom_text(aes(label = scales::percent(Value)), color = "black", vjust = 1.5, position = "stack") +
  theme(panel.background = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) +
  xlab("")

```


## Youth Program Quality Intervention Assessment

Youth Program Quality Assessment (YPQA)
*Assessment Tool (YPQA) is one portion of the intervention (YPQI).*
*Training start in August, assessments in oct/nov, implementing new practices takes place in next calendar year.*
*Years for this report are calendar years.*

BGCGH participates in the annual Youth Program Quality Intervention (YPQI) provided by United Way to conduct a self-assessment on four key areas: Safe Environment, Supportive Environment, Interaction, and Engagement. 

Program Quality Assessment (PQA) scores range from 1.0 to 5.0. In general, scores can be interpreted as follows:

- Score of 1 = The practice is not in place

- Score of 3 = The practice is available to a limited extent or in a less advanced form

- Score of 5 = The practice is widely available and/or with great frequency

These reports are self-assessments. Self assessment is a team based process where multiple program offerings are observed and as a result of a consensus meeting, one set of program-wide scores is submitted.


*Note: The Women’s Home, Westwood, and Woodview did not participate in the YPQI process in 2020 nor 2021 due to the pandemic so we have their 2019 report instead.*



```{r YPQI Data, include=FALSE}

# YPQI Data
# Import all pdf files
pdf.file.list <- list.files(pattern='*.pdf', recursive = TRUE)
pdf.list <- sapply(pdf.file.list, pdf_text, simplify = FALSE, USE.NAMES = TRUE)

# pdf.file.list
# pdf.list

# UPDATE if needed
# This code should also work for 2023 once it's added to the working folder, assuming the pdfs are the same as previous years.
# Note: The Women’s Home, Westwood, and Woodview did not participate in the YOPQI process in 2020 nor 2021 due to the pandemic so I have included their 2019 report instead. 

# File names to be joined with data later
ypqi.names <- data.frame(pdf.file.list) %>% 
  mutate(Site = row_number())

ypqi.list <- list()
  
for(pdf in 1:max(row_number(pdf.file.list))){
  
  ypqi.pdf_table <- map(pdf.list[[pdf]], ~ str_split(.x, "\n") %>% unlist())
  #specify the start and end of the table data
  ypqi.table <- ypqi.pdf_table[[4]][(str_which(ypqi.pdf_table[[4]], "Score Set 1")):(str_which(ypqi.pdf_table[[4]], "The"))] # Summary Report is on pg 4
  #Build the table and remove special characters
  ypqi.table <- str_replace_all(ypqi.table," \\s+ ", "|")
  ypqi.data_table <- read.csv(textConnection(ypqi.table), sep = "|")
  #Create a list of column names
  colnames(ypqi.data_table)<- c("Measure", "Score")
  
  ypqi.data_table <- ypqi.data_table %>% 
  mutate(Score = as.numeric(Score),
         Data = "YPQI")
  
ypqi.list[[pdf]] <- ypqi.data_table

}


ypqi <- bind_rows(list(ypqi.list), .id = "Site") %>% 
  mutate(Site = as.numeric(Site)) %>% 
  # Join data with file names
  full_join(ypqi.names, by = "Site") %>% 
  na.omit()

ypqi <- ypqi %>% 
  mutate(Site = ifelse(str_detect(ypqi$pdf.file.list, "SBE"), "Spring Branch Elementary", Site),
         Site = ifelse(str_detect(ypqi$pdf.file.list, "SO"), "Spring Oaks Middle", Site),
         Site = ifelse(str_detect(ypqi$pdf.file.list, "TWH"), "The Women's Home", Site),
         Site = ifelse(str_detect(ypqi$pdf.file.list, "WV"), "Woodview Elementary", Site),
         Site = ifelse(str_detect(ypqi$pdf.file.list, "WW"), "Westwood Elementary", Site),
         Year = ifelse(endsWith(ypqi$pdf.file.list, "2019.pdf"), "2019", ""),
         Year = ifelse(endsWith(ypqi$pdf.file.list, "2020.pdf"), "2020", Year),
         Year = ifelse(endsWith(ypqi$pdf.file.list, "2021.pdf"), "2021", Year),
         Year = ifelse(endsWith(ypqi$pdf.file.list, "2022.pdf"), "2022", Year),
         Year = ifelse(endsWith(ypqi$pdf.file.list, "2023.pdf"), "2023", Year))
```

Scores lower than 3 may be the best candidates for improvement action.

```{r}
# Pg 9 says scores lower than 3 may be the best candidates for improvement action
ypqi.below <- ypqi %>% 
  filter(Score < 3) %>% 
  mutate(Year = as.numeric(Year)) %>% 
  select(Year, Site, Measure, Score) %>% 
  arrange(Year)

kable(ypqi.below, caption = "YPQA Scores Under 3, 2019-2022")

```


In 2022, the lowest YPQA score was 1, for Encouragement at Spring Branch Elementary.

Recommendations for Encouragement, Supportive Environment Domain: 

- Youth Work, Ask-Listen-Encourage Method
    + Ask-Listen-Encourage is a method for carrying out positive, purposeful interactions with young people. The method includes practices that can both foster positive relationships with youth and support young people in learning new skills.



- Social Emotional Learning, Engaging Youth in Supportive Struggle Method
    + Optimal growth and learning occur when trusted and encouraging adults provide young people with enough challenge, with enough support. This workshop helps youth workers learn practical ways to normalize struggle and foster growth mindset in a balanced and nuanced way that acknowledges social inequities while encouraging perseverance, high expectations, and hope.



```{r fig.height=15, fig.width=8}

ypqi.sets <- ypqi %>% 
  filter(Measure == "I. SAFE ENVIRONMENT" | 
         Measure == "II. SUPPORTIVE ENVIRONMENT" | 
         Measure == "III. INTERACTION" | 
         Measure == "IV. ENGAGEMENT" | 
         Measure == "Instructional Total Score*") %>% 
  mutate(Measure = factor(Measure, levels=c("I. SAFE ENVIRONMENT", 
                                            "II. SUPPORTIVE ENVIRONMENT",
                                            "III. INTERACTION",
                                            "IV. ENGAGEMENT",
                                            "Instructional Total Score*")))


ggplot(data = ypqi.sets, aes(x = Measure, y = Score, fill = Score < 3)) + 
  geom_col() + 
  facet_grid(rows = vars(Site), cols = vars(Year)) +
  labs(title = "Program Quality Assessment Scores") +
  guides(x = guide_axis(angle = 90)) +
  geom_text(aes(label = Score), color = "Black", vjust = 1.5) +
  theme(panel.background = element_blank()) +
  scale_fill_brewer(name = "Score", labels = c("3 or more", "Less than 3"), palette = "Blues")

# UPDATE:
# Instructional total score should stand out (maybe bold it?)
# Don't highlight less than three - we want positive impact. Maybe highlight above 4?

```

# Results and Implications

# Limitations




```{r}

```


# Appendix One: Data Cleaning Notes

*One kid has an S in math, but as.numeric makes it NA, so it's automatically dropped*

*2021 ACE data has 6 duplicate member ids: "1841070" "1837954" "1838312" "1838401" "1839453" "1840898"*

*Spring 2023 Grade data has 11 duplicate Comet IDs: "1826954" "1841066" "1845474" "1853139" "1842531" "1851898" "1845379" "1854408" "1845372" "1852067" "1845368 But the all had unique Club IDs, so we might leave them in?*

*Two students from Fall 2022 Spring Oaks Middle are missing grade level information.*


# Appendix Two: Additional Data

*dump any graphs here that aren't going to be used in the final narrative*
